{% extends "dashboard.html" %}

{% block extra_js %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap modals
    const addUserModal = new bootstrap.Modal(document.getElementById('addUserModal'));
    const addRoleModal = new bootstrap.Modal(document.getElementById('addRoleModal'));
    const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    const viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));

    // State management
    let users = [];
    let roles = [];
    let currentView = 'all';
    let currentSort = { column: 'username', direction: 'asc' };
    let currentFilters = {
        status: 'all',
        role: 'all',
        search: ''
    };

    // Initialize the dashboard
    initializeDashboard();
    setupEventListeners();
    startRealTimeUpdates();

    function initializeDashboard() {
        loadUsers();
        loadRoles();
        updateStats();
        initializeCharts();
        renderUserTable();
        renderRoleTable();
    }

    function loadUsers() {
        // In a real application, this would be an API call
        users = [
            { id: 1, username: 'admin', email: 'admin@example.com', role: 'admin', status: 'active', lastLogin: '2024-03-15', department: 'IT', joinDate: '2024-01-01' },
            { id: 2, username: 'manager1', email: 'manager@example.com', role: 'manager', status: 'active', lastLogin: '2024-03-14', department: 'Operations', joinDate: '2024-01-15' },
            { id: 3, username: 'counselor1', email: 'counselor@example.com', role: 'counselor', status: 'active', lastLogin: '2024-03-13', department: 'Support', joinDate: '2024-02-01' },
            { id: 4, username: 'tech1', email: 'tech@example.com', role: 'technician', status: 'inactive', lastLogin: '2024-03-10', department: 'IT', joinDate: '2024-02-15' }
        ];
    }

    function loadRoles() {
        // In a real application, this would be an API call
        roles = [
            { id: 1, name: 'admin', permissions: ['all'], userCount: 1 },
            { id: 2, name: 'manager', permissions: ['view_users', 'manage_users', 'view_data'], userCount: 1 },
            { id: 3, name: 'counselor', permissions: ['view_data', 'manage_cases'], userCount: 1 },
            { id: 4, name: 'technician', permissions: ['view_tickets', 'manage_tickets'], userCount: 1 }
        ];
    }

    function updateStats() {
        const stats = {
            totalUsers: users.length,
            activeUsers: users.filter(u => u.status === 'active').length,
            totalRoles: roles.length,
            newUsers: users.filter(u => new Date(u.joinDate) > new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)).length
        };

        document.getElementById('totalUsersCount').textContent = stats.totalUsers;
        document.getElementById('activeUsersCount').textContent = stats.activeUsers;
        document.getElementById('totalRolesCount').textContent = stats.totalRoles;
        document.getElementById('newUsersCount').textContent = stats.newUsers;
    }

    function initializeCharts() {
        // User Distribution Chart
        const userDistCtx = document.getElementById('userDistributionChart').getContext('2d');
        new Chart(userDistCtx, {
            type: 'doughnut',
            data: {
                labels: ['Admin', 'Manager', 'Counselor', 'Technician'],
                datasets: [{
                    data: [
                        users.filter(u => u.role === 'admin').length,
                        users.filter(u => u.role === 'manager').length,
                        users.filter(u => u.role === 'counselor').length,
                        users.filter(u => u.role === 'technician').length
                    ],
                    backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#6366F1']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Activity Timeline Chart
        const activityCtx = document.getElementById('activityTimelineChart').getContext('2d');
        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'New Users',
                    data: [2, 3, 1, 4, 2, 3],
                    borderColor: '#3B82F6',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function renderUserTable() {
        const tbody = document.querySelector('#usersTable tbody');
        if (!tbody) return;

        let filteredUsers = [...users];

        // Apply filters
        if (currentFilters.status !== 'all') {
            filteredUsers = filteredUsers.filter(u => u.status === currentFilters.status);
        }
        if (currentFilters.role !== 'all') {
            filteredUsers = filteredUsers.filter(u => u.role === currentFilters.role);
        }
        if (currentFilters.search) {
            const searchTerm = currentFilters.search.toLowerCase();
            filteredUsers = filteredUsers.filter(u => 
                u.username.toLowerCase().includes(searchTerm) ||
                u.email.toLowerCase().includes(searchTerm) ||
                u.department.toLowerCase().includes(searchTerm)
            );
        }

        // Apply sorting
        filteredUsers.sort((a, b) => {
            const aVal = a[currentSort.column];
            const bVal = b[currentSort.column];
            const modifier = currentSort.direction === 'asc' ? 1 : -1;
            return aVal > bVal ? modifier : -modifier;
        });

        // Render table
        tbody.innerHTML = filteredUsers.map(user => `
            <tr data-user-id="${user.id}">
                <td>
                    <div class="user-info">
                        <div class="user-avatar">${user.username.charAt(0).toUpperCase()}</div>
                        <div>
                            <div class="user-name">${user.username}</div>
                            <div class="user-email">${user.email}</div>
                        </div>
                    </div>
                </td>
                <td><span class="role-badge ${user.role}">${user.role}</span></td>
                <td><span class="status-badge ${user.status}">${user.status}</span></td>
                <td>${user.department}</td>
                <td>${new Date(user.lastLogin).toLocaleDateString()}</td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn view" onclick="viewUser(${user.id})" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="action-btn edit" onclick="editUser(${user.id})" title="Edit User">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteUser(${user.id})" title="Delete User">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function renderRoleTable() {
        const tbody = document.querySelector('#rolesTable tbody');
        if (!tbody) return;

        tbody.innerHTML = roles.map(role => `
            <tr data-role-id="${role.id}">
                <td>
                    <div class="role-info">
                        <div class="role-icon">${role.name.charAt(0).toUpperCase()}</div>
                        <div class="role-name">${role.name}</div>
                    </div>
                </td>
                <td>${role.permissions.join(', ')}</td>
                <td>${role.userCount}</td>
                <td>
                    <div class="table-actions">
                        <button class="action-btn edit" onclick="editRole(${role.id})" title="Edit Role">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteRole(${role.id})" title="Delete Role">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function setupEventListeners() {
        // Search input
        const searchInput = document.getElementById('userSearch');
        if (searchInput) {
            searchInput.addEventListener('input', debounce((e) => {
                currentFilters.search = e.target.value;
                renderUserTable();
            }, 300));
        }

        // Status filter
        const statusFilter = document.getElementById('statusFilter');
        if (statusFilter) {
            statusFilter.addEventListener('change', (e) => {
                currentFilters.status = e.target.value;
                renderUserTable();
            });
        }

        // Role filter
        const roleFilter = document.getElementById('roleFilter');
        if (roleFilter) {
            roleFilter.addEventListener('change', (e) => {
                currentFilters.role = e.target.value;
                renderUserTable();
            });
        }

        // Table sorting
        document.querySelectorAll('#usersTable th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                currentSort.direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
                currentSort.column = column;
                renderUserTable();
            });
        });

        // Add User button
        const addUserBtn = document.getElementById('addUserBtn');
        if (addUserBtn) {
            addUserBtn.addEventListener('click', () => addUserModal.show());
        }

        // Add Role button
        const addRoleBtn = document.getElementById('addRoleBtn');
        if (addRoleBtn) {
            addRoleBtn.addEventListener('click', () => addRoleModal.show());
        }
    }

    function startRealTimeUpdates() {
        // Simulate real-time updates every 30 seconds
        setInterval(() => {
            updateStats();
            renderUserTable();
            renderRoleTable();
        }, 30000);
    }

    // Utility functions
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Export functions to window for onclick handlers
    window.viewUser = function(userId) {
        const user = users.find(u => u.id === userId);
        if (user) {
            // Populate view user modal
            document.getElementById('viewUserName').textContent = user.username;
            document.getElementById('viewUserEmail').textContent = user.email;
            document.getElementById('viewUserRole').textContent = user.role;
            document.getElementById('viewUserStatus').textContent = user.status;
            document.getElementById('viewUserDepartment').textContent = user.department;
            document.getElementById('viewUserLastLogin').textContent = new Date(user.lastLogin).toLocaleDateString();
            viewUserModal.show();
        }
    };

    window.editUser = function(userId) {
        const user = users.find(u => u.id === userId);
        if (user) {
            // Populate edit user modal
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editRole').value = user.role;
            document.getElementById('editStatus').value = user.status;
            document.getElementById('editDepartment').value = user.department;
            editUserModal.show();
        }
    };

    window.deleteUser = function(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            users = users.filter(u => u.id !== userId);
            renderUserTable();
            updateStats();
        }
    };

    window.editRole = function(roleId) {
        const role = roles.find(r => r.id === roleId);
        if (role) {
            // Populate edit role modal
            document.getElementById('editRoleId').value = role.id;
            document.getElementById('editRoleName').value = role.name;
            role.permissions.forEach(permission => {
                const checkbox = document.getElementById(`edit${permission}`);
                if (checkbox) checkbox.checked = true;
            });
            editRoleModal.show();
        }
    };

    window.deleteRole = function(roleId) {
        if (confirm('Are you sure you want to delete this role?')) {
            roles = roles.filter(r => r.id !== roleId);
            renderRoleTable();
            updateStats();
        }
    };
});
</script>
{% endblock %}

{% block content %}
<div class="users-roles-container">
    <!-- Header Section -->
    <div class="header">
        <div class="header-content">
            <h1>Users & Roles Management</h1>
            <p class="subtitle">Manage users, roles, and permissions across the platform</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" id="addUserBtn">
                <i class="bi bi-person-plus"></i> Add User
            </button>
            <button class="btn btn-outline-primary" id="addRoleBtn">
                <i class="bi bi-shield-plus"></i> Add Role
            </button>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">👥</div>
            <div class="stat-content">
                <div class="stat-value" id="totalUsersCount">0</div>
                <div class="stat-label">Total Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">✅</div>
            <div class="stat-content">
                <div class="stat-value" id="activeUsersCount">0</div>
                <div class="stat-label">Active Users</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">👑</div>
            <div class="stat-content">
                <div class="stat-value" id="totalRolesCount">0</div>
                <div class="stat-label">Total Roles</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">🆕</div>
            <div class="stat-content">
                <div class="stat-value" id="newUsersCount">0</div>
                <div class="stat-label">New This Month</div>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- User Distribution Chart -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>User Distribution</h3>
            </div>
            <div class="card-body">
                <canvas id="userDistributionChart"></canvas>
            </div>
        </div>

        <!-- Activity Timeline -->
        <div class="dashboard-card">
            <div class="card-header">
                <h3>User Activity</h3>
            </div>
            <div class="card-body">
                <canvas id="activityTimelineChart"></canvas>
            </div>
        </div>

        <!-- Users Table -->
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h3>Users</h3>
                <div class="card-actions">
                    <div class="search-box">
                        <i class="bi bi-search"></i>
                        <input type="text" id="userSearch" placeholder="Search users...">
                    </div>
                    <select id="statusFilter" class="form-select">
                        <option value="all">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <select id="roleFilter" class="form-select">
                        <option value="all">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="counselor">Counselor</option>
                        <option value="technician">Technician</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="usersTable" class="data-table">
                        <thead>
                            <tr>
                                <th data-sort="username">User</th>
                                <th data-sort="role">Role</th>
                                <th data-sort="status">Status</th>
                                <th data-sort="department">Department</th>
                                <th data-sort="lastLogin">Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- User data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Roles Table -->
        <div class="dashboard-card full-width">
            <div class="card-header">
                <h3>Roles & Permissions</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="rolesTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Role Name</th>
                                <th>Permissions</th>
                                <th>Users</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Role data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="user-details-grid">
                    <div class="detail-item">
                        <label>Username</label>
                        <div id="viewUserName"></div>
                    </div>
                    <div class="detail-item">
                        <label>Email</label>
                        <div id="viewUserEmail"></div>
                    </div>
                    <div class="detail-item">
                        <label>Role</label>
                        <div id="viewUserRole"></div>
                    </div>
                    <div class="detail-item">
                        <label>Status</label>
                        <div id="viewUserStatus"></div>
                    </div>
                    <div class="detail-item">
                        <label>Department</label>
                        <div id="viewUserDepartment"></div>
                    </div>
                    <div class="detail-item">
                        <label>Last Login</label>
                        <div id="viewUserLastLogin"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">Role</label>
                        <select class="form-select" id="editRole" required>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="counselor">Counselor</option>
                            <option value="technician">Technician</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editStatus" class="form-label">Status</label>
                        <select class="form-select" id="editStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editDepartment" class="form-label">Department</label>
                        <select class="form-select" id="editDepartment" required>
                            <option value="IT">IT</option>
                            <option value="Operations">Operations</option>
                            <option value="Support">Support</option>
                            <option value="HR">HR</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUserEdit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-select" id="role" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="manager">Manager</option>
                            <option value="counselor">Counselor</option>
                            <option value="technician">Technician</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="department" class="form-label">Department</label>
                        <select class="form-select" id="department" required>
                            <option value="">Select Department</option>
                            <option value="IT">IT</option>
                            <option value="Operations">Operations</option>
                            <option value="Support">Support</option>
                            <option value="HR">HR</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewUser()">Add User</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Role Modal -->
<div class="modal fade" id="addRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRoleForm">
                    <div class="mb-3">
                        <label for="roleName" class="form-label">Role Name</label>
                        <input type="text" class="form-control" id="roleName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="permissions-grid">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="viewUsers">
                                <label class="form-check-label" for="viewUsers">View Users</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="manageUsers">
                                <label class="form-check-label" for="manageUsers">Manage Users</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="viewData">
                                <label class="form-check-label" for="viewData">View Data</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="manageData">
                                <label class="form-check-label" for="manageData">Manage Data</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="adminAccess">
                                <label class="form-check-label" for="adminAccess">Admin Access</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewRole()">Add Role</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
