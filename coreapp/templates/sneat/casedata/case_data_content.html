{% extends "sneat/dashboard.html" %}

{% block content %}
    <div class="header">
        <div class="header-left">
            <h1>Case Management Dashboard</h1>
            <div class="header-subtitle">Monitor and manage all cases in real-time</div>
        </div>
        <div class="header-right">
            <button class="btn btn-primary" onclick="openNewCaseForm()">
                <i class="fas fa-plus"></i> New Case
            </button>
            <button class="btn btn-outline-primary" onclick="exportCaseData()">
                <i class="fas fa-download"></i> Export
            </button>
        </div>
    </div>

    <!-- Quick Actions Bar -->
    <div class="quick-actions">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="caseSearch" placeholder="Search cases...">
        </div>
        <div class="filter-group">
            <select id="statusFilter" class="filter-select">
                <option value="">All Statuses</option>
                <option value="new">New</option>
                <option value="open">Open</option>
                <option value="in-progress">In Progress</option>
                <option value="pending">Pending</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
            </select>
            <select id="priorityFilter" class="filter-select">
                <option value="">All Priorities</option>
                <option value="urgent">Urgent</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
            <select id="timeFilter" class="filter-select">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
            </select>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ðŸ“Š</div>
            <div class="stat-label">Total Active Cases</div>
            <div class="stat-value" id="totalActiveCases">0</div>
            <div class="stat-change stat-positive">â†— +8.2%</div>
            <div class="stat-footer">
                <span class="stat-footer-label">New Today:</span>
                <span class="stat-footer-value" id="newCasesToday">0</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âš¡</div>
            <div class="stat-label">Urgent Cases</div>
            <div class="stat-value" id="urgentCases">0</div>
            <div class="stat-change stat-negative">â†— +12.5%</div>
            <div class="stat-footer">
                <span class="stat-footer-label">Response Time:</span>
                <span class="stat-footer-value" id="avgResponseTime">0m</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-label">Resolution Rate</div>
            <div class="stat-value" id="resolutionRate">0%</div>
            <div class="stat-change stat-positive">â†— +5.4%</div>
            <div class="stat-footer">
                <span class="stat-footer-label">Avg Time to Resolve:</span>
                <span class="stat-footer-value" id="avgResolutionTime">0d</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ðŸ‘¥</div>
            <div class="stat-label">Active Staff</div>
            <div class="stat-value" id="activeStaff">0</div>
            <div class="stat-footer">
                <span class="stat-footer-label">Cases per Staff:</span>
                <span class="stat-footer-value" id="casesPerStaff">0</span>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="dashboard-grid">
        <!-- Case Trends Chart -->
        <div class="chart-card full-width">
            <div class="chart-header">
                <h3>Case Trends</h3>
                <div class="chart-actions">
                    <button class="btn btn-sm btn-outline-secondary active" data-view="volume">Volume</button>
                    <button class="btn btn-sm btn-outline-secondary" data-view="resolution">Resolution</button>
                    <button class="btn btn-sm btn-outline-secondary" data-view="response">Response Time</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="caseTrendsChart"></canvas>
            </div>
        </div>

        <!-- Case Distribution -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>Case Distribution</h3>
                <div class="chart-actions">
                    <select class="filter-select" id="distributionType">
                        <option value="category">By Category</option>
                        <option value="priority">By Priority</option>
                        <option value="status">By Status</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="caseDistributionChart"></canvas>
            </div>
        </div>

        <!-- Staff Performance -->
        <div class="chart-card">
            <div class="chart-header">
                <h3>Staff Performance</h3>
                <div class="chart-actions">
                    <select class="filter-select" id="performanceMetric">
                        <option value="cases">Cases Handled</option>
                        <option value="resolution">Resolution Rate</option>
                        <option value="satisfaction">Client Satisfaction</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="staffPerformanceChart"></canvas>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="activity-card">
            <div class="card-header">
                <h3>Recent Activity</h3>
                <button class="btn btn-sm btn-link" onclick="refreshActivity()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="activity-list" id="recentActivity">
                <!-- Activity items will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Case Table -->
    <div class="table-card">
        <div class="card-header">
            <h3>All Cases</h3>
            <div class="table-actions">
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshTable()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleColumns()">
                    <i class="fas fa-columns"></i>
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table" id="casesTable">
                <thead>
                    <tr>
                        <th>Case ID</th>
                        <th>Title</th>
                        <th>Client</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Status</th>
                        <th>Assigned To</th>
                        <th>Created</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Case rows will be dynamically added here -->
                </tbody>
            </table>
        </div>
        <div class="table-footer">
            <div class="table-info">
                Showing <span id="tableStart">1</span> to <span id="tableEnd">10</span> of <span id="tableTotal">0</span> cases
            </div>
            <div class="pagination" id="tablePagination">
                <!-- Pagination will be dynamically added here -->
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize dashboard when the page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadCaseData();
    setupEventListeners();
    startRealTimeUpdates();
});

function initializeCharts() {
    // Case Trends Chart
    const trendsCtx = document.getElementById('caseTrendsChart').getContext('2d');
    new Chart(trendsCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'New Cases',
                data: [65, 59, 80, 81, 56, 55],
                borderColor: '#3b82f6',
                tension: 0.4
            }, {
                label: 'Resolved Cases',
                data: [28, 48, 40, 19, 86, 27],
                borderColor: '#10b981',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Case Distribution Chart
    const distributionCtx = document.getElementById('caseDistributionChart').getContext('2d');
    new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: ['Child Protection', 'GBV', 'Mental Health', 'Family', 'Other'],
            datasets: [{
                data: [30, 25, 20, 15, 10],
                backgroundColor: [
                    '#ef4444',
                    '#f59e0b',
                    '#10b981',
                    '#3b82f6',
                    '#8b5cf6'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });

    // Staff Performance Chart
    const performanceCtx = document.getElementById('staffPerformanceChart').getContext('2d');
    new Chart(performanceCtx, {
        type: 'bar',
        data: {
            labels: ['John D.', 'Sarah M.', 'Mike R.', 'Lisa K.', 'Tom B.'],
            datasets: [{
                label: 'Cases Handled',
                data: [45, 38, 42, 35, 40],
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function loadCaseData() {
    // Implement case data loading logic
    console.log('Loading case data...');
    // This would typically make an AJAX call to get the data
}

function setupEventListeners() {
    // Search input
    document.getElementById('caseSearch').addEventListener('input', debounce(function(e) {
        filterCases();
    }, 300));

    // Filter selects
    document.getElementById('statusFilter').addEventListener('change', filterCases);
    document.getElementById('priorityFilter').addEventListener('change', filterCases);
    document.getElementById('timeFilter').addEventListener('change', filterCases);
    document.getElementById('distributionType').addEventListener('change', updateDistributionChart);
    document.getElementById('performanceMetric').addEventListener('change', updatePerformanceChart);

    // Chart view buttons
    document.querySelectorAll('.chart-actions .btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.chart-actions .btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateTrendsChart(this.dataset.view);
        });
    });
}

function startRealTimeUpdates() {
    // Implement real-time updates using WebSocket or polling
    setInterval(updateDashboard, 30000); // Update every 30 seconds
}

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function filterCases() {
    // Implement case filtering logic
    console.log('Filtering cases...');
}

function updateDistributionChart() {
    // Implement distribution chart update logic
    console.log('Updating distribution chart...');
}

function updatePerformanceChart() {
    // Implement performance chart update logic
    console.log('Updating performance chart...');
}

function updateTrendsChart(view) {
    // Implement trends chart update logic
    console.log('Updating trends chart with view:', view);
}

function refreshActivity() {
    // Implement activity refresh logic
    console.log('Refreshing activity...');
}

function refreshTable() {
    // Implement table refresh logic
    console.log('Refreshing table...');
}

function toggleColumns() {
    // Implement column visibility toggle logic
    console.log('Toggling columns...');
}

function openNewCaseForm() {
    // Implement new case form opening logic
    console.log('Opening new case form...');
}

function exportCaseData() {
    // Implement case data export logic
    console.log('Exporting case data...');
}

function updateDashboard() {
    // Implement dashboard update logic
    console.log('Updating dashboard...');
}
</script>
{% endblock %}
