{% extends "dashboard.html" %}

{% block title %}Call Data Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_styles.css') }}">
{% endblock %}

{% block content %}
<div class="content-header">
    <div class="header-left">
        <h1>Call Data Dashboard</h1>
        <div class="header-subtitle">Monitor and analyze call center performance</div>
    </div>
    <div class="header-right">
        <button class="btn btn-primary">
            <i class="fas fa-plus"></i>
            New Call
        </button>
    </div>
</div>

<div class="quick-stats">
    <div class="stat-card">
        <div class="stat-label">Total Calls Today</div>
        <div class="stat-value">{{ total_calls_today }}</div>
        <div class="stat-change {% if call_change > 0 %}positive{% else %}negative{% endif %}">
            {{ call_change }}% from yesterday
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Average Call Duration</div>
        <div class="stat-value">{{ avg_call_duration }} min</div>
        <div class="stat-change {% if duration_change > 0 %}positive{% else %}negative{% endif %}">
            {{ duration_change }}% from yesterday
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Active Agents</div>
        <div class="stat-value">{{ active_agents }}</div>
        <div class="stat-change {% if agent_change > 0 %}positive{% else %}negative{% endif %}">
            {{ agent_change }}% from yesterday
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Call Resolution Rate</div>
        <div class="stat-value">{{ resolution_rate }}%</div>
        <div class="stat-change {% if resolution_change > 0 %}positive{% else %}negative{% endif %}">
            {{ resolution_change }}% from yesterday
        </div>
    </div>
</div>

<div class="content-body">
    <!-- Call Volume Chart -->
    <div class="card chart-card full-width">
        <div class="card-header">
            <h2 class="card-title">Call Volume Trends</h2>
            <div class="card-actions">
                <select class="filter-select" id="timeRange">
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                </select>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="callVolumeChart"></canvas>
        </div>
    </div>

    <!-- Call Distribution -->
    <div class="card chart-card">
        <div class="card-header">
            <h2 class="card-title">Call Distribution</h2>
            <div class="card-actions">
                <select class="filter-select" id="distributionType">
                    <option value="category">By Category</option>
                    <option value="priority">By Priority</option>
                </select>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="callDistributionChart"></canvas>
        </div>
    </div>

    <!-- Agent Performance -->
    <div class="card chart-card">
        <div class="card-header">
            <h2 class="card-title">Agent Performance</h2>
            <div class="card-actions">
                <select class="filter-select" id="performanceMetric">
                    <option value="calls">Calls Handled</option>
                    <option value="duration">Avg Duration</option>
                    <option value="satisfaction">Satisfaction</option>
                </select>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="agentPerformanceChart"></canvas>
        </div>
    </div>

    <!-- Recent Calls Table -->
    <div class="card table-container">
        <div class="card-header">
            <h2 class="card-title">Recent Calls</h2>
            <div class="card-actions">
                <div class="search-box">
                    <input type="text" placeholder="Search calls..." id="callSearch">
                </div>
                <select class="filter-select" id="callStatus">
                    <option value="all">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="in-progress">In Progress</option>
                    <option value="missed">Missed</option>
                </select>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Call ID</th>
                        <th>Time</th>
                        <th>Agent</th>
                        <th>Category</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for call in recent_calls %}
                    <tr>
                        <td>{{ call.id }}</td>
                        <td>{{ call.time }}</td>
                        <td>{{ call.agent }}</td>
                        <td>{{ call.category }}</td>
                        <td>{{ call.duration }}</td>
                        <td>
                            <span class="badge badge-{{ call.status_class }}">
                                {{ call.status }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="viewCallDetails('{{ call.id }}')">
                                View
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Call Volume Chart
    const volumeCtx = document.getElementById('callVolumeChart').getContext('2d');
    new Chart(volumeCtx, {
        type: 'line',
        data: {
            labels: {{ call_volume_labels|tojson }},
            datasets: [{
                label: 'Call Volume',
                data: {{ call_volume_data|tojson }},
                borderColor: '#3b82f6',
                tension: 0.4,
                fill: true,
                backgroundColor: 'rgba(59, 130, 246, 0.1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Call Distribution Chart
    const distributionCtx = document.getElementById('callDistributionChart').getContext('2d');
    new Chart(distributionCtx, {
        type: 'doughnut',
        data: {
            labels: {{ call_distribution_labels|tojson }},
            datasets: [{
                data: {{ call_distribution_data|tojson }},
                backgroundColor: [
                    '#3b82f6',
                    '#10b981',
                    '#f59e0b',
                    '#ef4444',
                    '#8b5cf6'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Agent Performance Chart
    const performanceCtx = document.getElementById('agentPerformanceChart').getContext('2d');
    new Chart(performanceCtx, {
        type: 'bar',
        data: {
            labels: {{ agent_performance_labels|tojson }},
            datasets: [{
                label: 'Calls Handled',
                data: {{ agent_performance_data|tojson }},
                backgroundColor: '#3b82f6'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
});

// Handle filter changes
document.getElementById('timeRange').addEventListener('change', updateCharts);
document.getElementById('distributionType').addEventListener('change', updateCharts);
document.getElementById('performanceMetric').addEventListener('change', updateCharts);
document.getElementById('callStatus').addEventListener('change', filterCalls);
document.getElementById('callSearch').addEventListener('input', filterCalls);

function updateCharts() {
    // Implement chart update logic here
    // This would typically make an AJAX call to get new data
    console.log('Updating charts...');
}

function filterCalls() {
    // Implement call filtering logic here
    console.log('Filtering calls...');
}

function viewCallDetails(callId) {
    // Implement call details view logic here
    console.log('Viewing call:', callId);
}
</script>
{% endblock %}
